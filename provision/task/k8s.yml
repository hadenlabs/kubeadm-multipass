version: '3'

tasks:
  check:
    desc: Exist multipass and dependences
    run: once
    deps:
      - task: check:multipass
      - task: check:kubectl

  check:multipass:
    desc: Exist multipass
    run: once
    preconditions:
      - sh: command -v multipass
        msg: 'Please Install multipass'

  check:kubectl:
    desc: Exist kubectl
    run: once
    preconditions:
      - sh: command -v kubectl
        msg: 'Please Install kubectl'

  apply:
    desc: apply kubectl.
    run: once
    deps:
      - task: check
    cmds:
      - cmd: KUBECONFIG={{.KUBECONFIG}} kubectl apply -k {{.MANIFEST_PATH}}

  apply:all:
    desc: apply kubectl all.
    run: once
    deps:
      - task: check
    cmds:
      - task: apply:core

  apply:core:
    desc: apply kubectl core.
    run: once
    deps:
      - task: check
    cmds:
      - task: apply
        vars:
          MANIFEST_PATH: provision/k8s/manifests/overlays/core
